# Fastfile for Nuxbe Mobile

default_platform(:ios)

platform :ios do
  desc "Build production IPA without uploading"
  lane :build do
    setup_ci if ENV['CI']

    # Set version from tag if provided
    if ENV['APP_VERSION'] && !ENV['APP_VERSION'].empty?
      increment_version_number(
        version_number: ENV['APP_VERSION'],
        xcodeproj: "App.xcodeproj"
      )
    end

    # Set build number if provided, otherwise increment
    if ENV['BUILD_NUMBER'] && !ENV['BUILD_NUMBER'].empty?
      increment_build_number(
        build_number: ENV['BUILD_NUMBER'],
        xcodeproj: "App.xcodeproj"
      )
    end

    app_identifier = ENV['APP_IDENTIFIER'] || "com.teamnifty.nuxbe"
    prod_profile = ENV['PROVISIONING_PROFILE_SPECIFIER']

    export_opts = {
      method: "app-store",
      signingStyle: "manual"
    }

    if prod_profile && !prod_profile.empty?
      export_opts[:provisioningProfiles] = {
        app_identifier => prod_profile
      }
    end

    xcargs = []
    xcargs << "DEVELOPMENT_TEAM=YS428GD6FU"
    if prod_profile && !prod_profile.empty?
      xcargs << "PROVISIONING_PROFILE_SPECIFIER='#{prod_profile}'"
    end

    gym(
      scheme: "App",
      workspace: "App.xcworkspace",
      export_method: "app-store",
      clean: true,
      output_directory: "./build",
      output_name: "nuxbe-mobile.ipa",
      export_options: export_opts,
      xcargs: xcargs.join(' ')
    )
  end

  desc "Upload IPA to TestFlight"
  lane :upload do
    api_key = app_store_connect_api_key(
      key_id: ENV['ASC_KEY_ID'],
      issuer_id: ENV['ASC_ISSUER_ID'],
      key_filepath: File.expand_path(ENV['ASC_KEY_PATH']),
    )

    ipa_path = ENV['IPA_PATH'] || Dir['./build/**/*.ipa'].map { |f| File.expand_path(f) }.first
    UI.user_error!("No IPA file found") unless ipa_path

    upload_to_testflight(
      api_key: api_key,
      ipa: ipa_path,
      skip_waiting_for_build_processing: true,
    )
  end

  desc "Upload screenshots to App Store Connect"
  lane :upload_screenshots do
    api_key = app_store_connect_api_key(
      key_id: ENV['ASC_KEY_ID'],
      issuer_id: ENV['ASC_ISSUER_ID'],
      key_filepath: File.expand_path(ENV['ASC_KEY_PATH']),
    )

    deliver(
      api_key: api_key,
      app_identifier: ENV['APP_IDENTIFIER'] || "com.teamnifty.nuxbe",
      skip_binary_upload: true,
      skip_metadata: true,
      overwrite_screenshots: true,
      screenshots_path: "./fastlane/screenshots",
      force: true,
      precheck_include_in_app_purchases: false,
    )
  end

  desc "Build development IPA"
  lane :build_development do
    setup_ci if ENV['CI']

    app_identifier = ENV['APP_IDENTIFIER'] || "com.teamnifty.nuxbe"
    dev_profile = ENV['DEV_PROVISIONING_PROFILE_SPECIFIER']

    export_opts = {
      method: "development",
      signingStyle: "manual"
    }

    if dev_profile && !dev_profile.empty?
      export_opts[:provisioningProfiles] = {
        app_identifier => dev_profile
      }
    end

    xcargs = []
    xcargs << "DEVELOPMENT_TEAM=YS428GD6FU"
    xcargs << "CODE_SIGN_STYLE=Manual"
    if dev_profile && !dev_profile.empty?
      xcargs << "PROVISIONING_PROFILE_SPECIFIER='#{dev_profile}'"
    end

    gym(
      scheme: "App",
      workspace: "App.xcworkspace",
      configuration: "Debug",
      export_method: "development",
      clean: true,
      output_directory: "./build",
      output_name: "nuxbe-mobile-dev.ipa",
      export_options: export_opts,
      xcargs: xcargs.join(' ')
    )
  end

  desc "Download provisioning profiles"
  lane :sync_profiles do
    match(type: "appstore", readonly: true)
    match(type: "development", readonly: true)
  end

  desc "Register new device"
  lane :add_device do |options|
    register_devices(devices: { options[:name] => options[:udid] })
    match(type: "development", force_for_new_devices: true)
  end
end

platform :android do
  desc "Upload AAB to Google Play (internal testing track)"
  lane :upload do
    aab_path = ENV['AAB_PATH']
    UI.user_error!("No AAB file found - set AAB_PATH") unless aab_path

    upload_to_play_store(
      aab: aab_path,
      track: "internal",
      release_status: "draft",
      json_key: ENV['PLAY_STORE_SERVICE_ACCOUNT_JSON_PATH'],
      package_name: "com.teamnifty.nuxbe",
      skip_upload_metadata: true,
      skip_upload_changelogs: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
    )
  end
end
